# [DB] 트랜잭션 (Transaction)

<aside>
💡 트랜잭션이란?

데이터베이스의 상태를 변경시키기 위해 작업을 수행하는 하나의 논리적인 단위를 의미

</aside>

### 트랜잭션의 특징

- 원자성(Atomicity)
트랜잭션이 수행 될때 DB에 모두 반영되거나, 모두 반영되지 않거나를 의미
    
    **All or Nothing** 
    
- 일관성(Consistency)
트랜잭션 **작업의 처리 결과가 항상 일관** 되어야 함. 
데이터 타입이 반환 전과 후 동일해야함
- 독립성(Isolation)
하나의 트랜잭션은 **다른 트랜잭션에 간섭이 불가능 반대도 마찬가지**로 독립적임
- 지속성(Durability)
트랜잭션이 **성공적으로 완료되면 영구적으로 결과에 반영**되어야함.

### 트랜잭션의 Commit 과 Rollback

- Commit
하나의 **트랜잭션이 성공적으로 끝나서 데이터베이스가 일관성 있는 상태**에 있음을 의미
- Rollback
트랜잭션 원자성이 깨질때, **하나의 트랜잭션 처리가 비정상적으로 종료된 상태**를 의미
Rollback 이 실행되면 트랜잭션을 다시 실행하거나 부분적으로 변경된 결과를 취소 할 수 있음

### 트랜잭션의 연산과정

![스크린샷 2022-05-17 오전 9.41.13.png](%5BDB%5D%20%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20(Transaction)%20fae2a350196a487a947a7b90fa255f7d/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-17_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_9.41.13.png)

- 활성(Active)
트랜잭션이 정상적으로 실행중인 상태
- 실패(Failed)
트랜잭션 실행에 오류가 발생하여 중단된 상태
- 철회(Aborted)
트랜잭션이 비정상적으로 종료되어 Rollback연산을 수행한 상태
- 부분완료(Partially Committed)
트랜잭션의 마지막 연산까지 실행했지만, Commit 연산이 실행되기 직전의 상태
- 완료(Committed)
트랜잭션이 성공적으로 종료되어 Commit 연산을 실행한 후의 상태

### 트랜잭션의 격리수준 (Isolation level)

<aside>
💡 Isolation level
트랜잭션에 일관성 없는 데이터를 허용하는 수준

</aside>

- 데이터베이스는 ACID 특징처럼 트랜잭션이 독립적으로 수행되도록함
- Locking을 통해 한 트랜잭션이 다른 트랜잭션을 간섭 할 수 없도록함
- 무조건적인 Locking은 DB의 성능저하를 유발, Locking의 범위를 줄이게 되면 데이터무결성 떨어짐
- **효율적이 Locking 관리가 필요**

### Isolation level 단계

- Read Uncommitted (레벨0)
트랜잭션 처리중이거나, 아직 Commit 되지 않은 데이터를 다른 트랜잭션이 읽는 것을 허용
    
    ```bash
    * Dirty Read 발생
    A 트랜잭션에서 데이터를 입력, 아직 Commit 되지 않음
    B 트랜잭션에서 데이터를 Read,이후 A트랜잭션에서 문제발생하여 Rollback 수행
    B 트랜잭션은 이전의 A 데이터로 연산을 수행
    ```
    
         **데이터 일관성을 유지 하는것이 불가능** 
    

- Read Committed (레벨1)
SELECT 문장이 수행되는 동안 해당 데이터에 Shared Lock이 걸리는 계층
트랜잭션이 수행되는 동안 다른 트랜잭션이 접근 할 수 없어 대기 하게 됨
Commit 이 이루어진 트랜잭션만 조회 가능
    
    ```bash
    A 트랜잭션에서 데이터를 바꾸고 Commit 하기 전까지 B트랜잭션에서 Read 할 수 없음
    
    * Non-Repeatable Read 발생
    B 트랜잭션에서 데이터 Read -> 30
    A 트랜잭션 30 -> 35 로 업데이트 후 Commit , B트랜잭션에서 해당 SELECT 를 수행할수 없는 상태
    B 트랜잭션에서 데이터 Read -> 35
    
    B 트랜잭션에서 같은 쿼리를 두번 수행중에 Update가 발생하여 동일한 두 쿼리 결과값이 상이함
    데이터 정합성 문제 발생
    ```
    

- Repeatable Read (레벨2)
    
    트랜잭션이 완료될 때까지 SELECT 문장이 사용하는 모든 데이터에 Shared Lock 이 걸리는 계층 
    
    트랜잭션이 조회한 범위 내에서 데이터 내용이 항상 동일함을 보장
    
    다른 사용자는 해당 트랜잭션 영역에 해당 되는 **데이터의 수정이 불가능**
    
    ```bash
    * Phantom Read 발생
    한 트랜잭션 안에서 일정 범위의 레코드를 두번 이상 읽었을 때, 첫번째 쿼리에서 없던 레코드가
    두번째 쿼리에서 나타나는 현상
    트랜잭션 도중 새로운 레코드 삽입을 허용하기 때문에 발생하는 현상
    ```
    
- Serializable (레벨3)
    
    트랜잭션이 완료될 때까지 SELECT 문장이 사용하는 모든 데이터에 Shared Lock 이 걸리는 계층 
    
    가장 엄격한 격리 수준으로 완벽한 읽기 일관성 모드를 제공함
    
    다른 사용자는 트랜잭션 영역에 해당되는 **데이터에 대한 수정 및 입력 불가능**
    

<aside>
💡 Isolation level에 대한 조정은 동시성과 데이터 무결성에 연관
동시성을 증가시키면 데이터 무결성에 문제가 발생하고, 데이터 무결성을 유지하면 동시성이 떨어지게 됨
레벨을 높게 조정 할 수록 고립정도가 높아지고, 성능이 떨어지는 것이 일반적이며 발생하는 비용이 증가함

</aside>