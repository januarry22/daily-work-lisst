# 실결제 테스트

### 1)  할인 적용된 금액(E)에 쿠폰 차감액 적용

 a. (포인트 O, 쿠폰 O)

- 상품 할인 적용 승인 금액
고객이 쿠폰가, 포인트 적용 할인 금액으로 결제한 금액 ( 쿠폰/포인트를 비율로 각각 상품금액에 적용 후  승인된 금액)

| 총 금액  | 54,000 |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| 포인트 | 2,000 |  |  |  |  |  |
| 쿠폰 | 3,000 | 총 금액 / (X) | (X) * (B) | (X) * (C) | (X) - (D) |  (E) - (D) |
| 카드 결제  | 49,000 | 상품 금액 비율
(A) | 쿠폰 차감 금액
(쿠폰금액 * 비율)
(B)  | 포인트 환급 금액 (포인트 * 비율)
(C) | 실제 상품 승인 금액
(E)  | 카드 취소 금액 
(F)  |
| 상품 1 (X) | 10,000 | 0.19 | 570 | 380 | 9050 | 8860 |
| 상품 2 | 24,000 | 0.44 | 1320 | 880 | 21800 | 21360 |
| 상품 3 | 20,000 | 0.37 | 1110 | 740 | 18150 | 17780 |
|  |  |  | 3000 | 2000 | 49000  | 48000 |
- **구매 당시 할인 적용 된 금액(E) 을 구매 금액으로 고려**

b. (포인트 x, 쿠폰  O)

| 총 금액  | 54,000 |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 포인트 | 0 |  |  |  |  |  |  |
| 쿠폰 | 3,000 | 총 금액 / (X) | (X) * (B) | (X) * (C) | (B) - (C) | (X) - (D) |  (E) - (D) |
| 카드 결제  | 51,000 | 상품 금액 비율
(A) | 쿠폰 차감 금액
(쿠폰금액 * 비율)
(B)  | 포인트 환급 금액 (포인트 * 비율)
(C) | 최종 차감 금액
(D) | 실제 상품 승인 금액
(E)  | 카드 취소 금액 
(F)  |
| 상품 1 (X) | 10,000 | 0.19 | 570 | 0 | 570 | 9430 | 8860 |
| 상품 2 | 24,000 | 0.44 | 1320 | 0 | 1320 | 22680 | 21360 |
| 상품 3 | 20,000 | 0.37 | 1110 | 0 | 1110 | 18890 | 17780 |
|  |  |  | 3000 |  | 3000 | 51000 | 48000 |
- 이 경우 쿠폰 (-3,000원)에 대한 패널티 적용으로 총 카드 취소 금액 (-3,000) 의 고객 패널티 발생

### 2) 상품 금액(X)에 쿠폰 차감액 적용

1. (포인트 O, 쿠폰 O)

| 총 금액  | 54,000 |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| 포인트 | 2,000 |  |  |  |  |  |
| 쿠폰 | 3,000 |  |  |  | 쿠폰 - 포인트  | (X) - (D) |
| 카드 결제  | 49,000 | 상품 금액 비율
(A) | 쿠폰 환급 금액(쿠폰금액 * 비율)
(B) | 포인트 환급 금액 (포인트 * 비율)
(C) | 최종 차감 금액
(D) | 카드 취소 금액 
(E)  |
| 상품 1 (X) | 10,000 | 0.19 | 570 | 380 | 190 | 9810 |
| 상품 2 | 24,000 | 0.44 | 1320 | 880 | 440 | 23560 |
| 상품 3 | 20,000 | 0.37 | 1110 | 740 | 370 | 19630 |
|  |  |  | 3000 | 2000 | 1000 | 53000 |

이 경우 포인트 금액에서 먼저 차감 되기 때문에 

카드 결제요청 된 금액 (49,000) 보다 취소금액 (53,000)이 초과됨으로 페이플 결제 취소 불가능.

<aside>
💡 페이플 :
 요청금액 보다 취소금액이 많을경우 자체적으로 취소 불가능

</aside>

- 마지막 취소시 남은 금액에 대해서만 결제 취소
- b-2 의 시나리오 적용

b. (포인트 X, 쿠폰 O)

| 총 금액  | 54,000 |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| 포인트 | 0 |  |  |  |  |  |
| 쿠폰 | 3,000 |  |  |  | 쿠폰 + 포인트  | (X) - (D) |
| 카드 결제  | 51,000 | 상품 금액 비율
(A) | 쿠폰 환급 금액(쿠폰금액 * 비율)
(B) | 포인트 환급 금액 (포인트 * 비율)
(C) | 최종 차감 금액
(D) | 카드 취소 금액 
(E)  |
| 상품 1 (X) | 10,000 | 0.19 | 570 | 0 | 570 | 9430 |
| 상품 2 | 24,000 | 0.44 | 1320 | 0 | 1320 | 22680 |
| 상품 3 | 20,000 | 0.37 | 1110 | 0 | 1110 | 18890 |
|  |  |  | 3000 | 0 | 3000 | 51000 |

요청된 금액과 3건에 대한 각각의 카드 취소 금액과 쿠폰 비율대로 차감 후 결제 취소 

- 패널티 따로 없음
- **구매 당시의 상품가(X)를 구매금액으로 고려**

b-2. **포인트 선차감 없이 적용**

| 총 금액  | 54,000 |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| 포인트 | 2,000 |  |  | 반환처리  |  |  |
| 쿠폰 | 3,000 | 총 금액 / (X) | (X) * (B) | (X) * (C) | (B) + (C) |  (E) - (D) |
| 카드 결제  | 49,000  | 상품 금액 비율
(A) | 쿠폰 차감 금액
(쿠폰금액 * 비율)
(B)  | 포인트 환급 금액 (포인트 * 비율)
(C) | 최종 차감 금액
(D) | 카드 취소 금액 
(F)  |
| 상품 1 (X) | 10,000 | 0.19 | 570 | 380 | 950 | 9,050 (380P) |
| 상품 2 | 24,000 | 0.44 | 1320 | 880 | 2200 | 21,800 (880P) |
| 상품 3 | 20,000 | 0.37 | 1110 | 740 | 1850 | 18,150 (740P) |
|  |  |  | 3000 | 2000 | 3000 | 49000 
(포인트 최종 반환 : 2000) |
- **포인트는 건별로 반환**되고 **쿠폰 비율별 차감금액만 적용** 시킴
- 카드 결제 금액과 취소금액 취소 시나리오 일치
- 포인트 선차감 없음

<aside>
💡 위 내용들을 정리했을때,
 1) 의 경우는 쿠폰금액에 대한 금액을 추가적으로 차감하는 방향입니다.
    - 고객이 구매한 상품의 할인된 금액에  적용시켜 추가적인 패널티 부여 
    - 쿠폰금액이나 포인트 비율별로 일정하게 패널티 금액이 남게 됩니다.
    - 패널티에대한 금액은 쇼핑몰 이윤으로 전환 (확인필요)

 2) 에서 b의 경우엔 패널티 부여없이 취소가 가능하나, a처럼 포인트에서 선차감 하는경우 
카드 취소금액이 요청 금액을 초과함으로 고객측의 추가 결제가 필요해보입니다.
    - a 의 경우 마지막 1건에 대해 취소시 남은 금액을 모두 반환하는 방향을 추가적으로 고려해서 수정되 어야 할 것같습니다. 이는 시스템적으로 추가 개발이 필요한 사항입니다.
    - b-2 처럼 포인트에서 선차감이 없는 경우 결제 시나리오가 일치하게 됩니다.(현재 시스템구조상 최적)

</aside>